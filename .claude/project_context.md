# プロジェクトコンテキスト

## 目的・背景

友人・グループでブラウザだけで気軽にカードゲームを楽しめるWebアプリ。
インストール不要・アカウント登録不要で、ニックネームを入力するだけで即プレイできることを重視する。

## ターゲットユーザー

- オンラインで友人とカジュアルにゲームをしたいユーザー
- 2〜10人のグループでの利用を想定

## 非機能要件

| 項目 | 要件 |
|------|------|
| 同時接続数 | 1ルームあたり最大10人 |
| レイテンシ | ゲーム操作の遅延は体感できないレベル（WebSocket活用） |
| 可用性 | Redis障害時はゲーム状態が失われる（揮発性を許容する設計） |
| 認証 | ニックネームのみ（パスワード・メール不要） |
| データ永続化 | なし（Redisのインメモリのみ、サーバー再起動で状態消滅） |

## プレイヤーフロー

```
1. ブラウザでアクセス
      ↓
2. ニックネームを入力
      ↓
3-A. 新規ルーム作成（最大人数を設定）→ room_id 発行
3-B. 既存ルームに参加（room_id を入力）
      ↓
4. 全員が揃ったらゲーム開始（ホストが開始ボタン）
      ↓
5. カード配布 → ターン制でカードをプレイ → 勝敗判定
      ↓
6. ゲーム終了 → 結果表示 → 再戦 or ルーム退出
```

## ゲーム状態管理の設計思想

DBを持たず、全状態をRedisで管理する。

### Redisキー設計（想定）

| キー | 型 | 内容 |
|------|----|------|
| `room:{room_id}` | Hash | ルーム情報（状態・最大人数・ホスト等） |
| `room:{room_id}:players` | List | 参加プレイヤー一覧 |
| `room:{room_id}:game` | Hash | ゲーム状態（山札・捨て札・ターン等） |
| `player:{player_id}:hand` | List | 各プレイヤーの手札 |

TTL（有効期限）を設定し、放置されたルームは自動削除する。

## WebSocket接続フロー詳細

```
1. クライアント: ws://backend/ws/{player_id} に接続
2. サーバー: ConnectionManager に登録
3. クライアント: create_room または join_room イベント送信
4. サーバー: Redisにルーム状態を作成・更新
5. サーバー: 同ルームの全クライアントに player_joined をブロードキャスト
6. ゲーム中: play_card → Redis更新 → card_played ブロードキャスト
7. 切断時: サーバーがConnectionManagerから削除 → 他プレイヤーに通知
```

## 今後の開発予定（ロードマップ）

### 近期（MVP後）
- [ ] 複数のカードゲームルール対応
- [ ] チャット機能
- [ ] 自動テスト追加（pytest / Vitest）

### 中期
- [ ] リプレイ機能
- [ ] ランキングシステム
- [ ] スペクテーターモード

### 長期
- [ ] ユーザー登録・ログイン（オプション）
- [ ] パフォーマンス最適化
- [ ] モバイル対応強化
