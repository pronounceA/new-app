# プロジェクトコンテキスト

## 目的・背景

友人・グループでブラウザだけで気軽にカードゲームを楽しめるWebアプリ。
インストール不要・アカウント登録不要で、ニックネームを入力するだけで即プレイできることを重視する。

## ターゲットユーザー

- オンラインで友人とカジュアルにゲームをしたいユーザー
- 2〜6人のグループでの利用を想定

## 非機能要件

| 項目 | 要件 |
|------|------|
| 同時接続数 | 1ルームあたり最大6人 |
| レイテンシ | ゲーム操作の遅延は体感できないレベル（WebSocket活用） |
| 可用性 | Redis障害時はゲーム状態が失われる（揮発性を許容する設計） |
| 認証 | ニックネームのみ（パスワード・メール不要） |
| データ永続化 | なし（Redisのインメモリのみ、サーバー再起動で状態消滅） |

## ゲームルール

### カード構成

| 数字 | 枚数 |
|------|------|
| 1〜5 | 各13枚 |
| 6〜10 | 各9枚 |
| **合計** | **110枚** |

- 手札はなし。引いたカードは直接自分の「場」に置かれる。

### 用語定義

| 用語 | 意味 |
|------|------|
| 場（フィールド） | 各プレイヤーが引いたカードを置くエリア。得点化またはバーストで空になる |
| 得点化 | 場のカードをすべて得点に変換し、場を空にする行動 |
| バースト | 場に置いたカードが既存カードと数字が一致し、かつ場に3枚以上ある場合に発生。場のカードをすべて失う |
| 横取り | 引いたカードが別プレイヤーの場のカードと数字が一致する場合に行える任意行動 |

### ターンフロー

```
ターン開始
  ↓
[STEP 1] 得点化（場にカードがある場合は必須）
  → 場のカードを得点に加算し、場を空にする
  ↓
[STEP 2] カードを引く
  → 山札から1枚引き、自分の場に置く
  ↓
[STEP 3A] 通常（バースト条件を満たさない場合）
  → 他プレイヤーへの横取りチャンスがあれば選択可能
  → ターン終了
[STEP 3B] バースト（場に3枚以上 かつ 引いたカードと場の既存カードの数字が一致）
  → 場のカードをすべて失う（得点化不可）
  → ターン終了
```

### 横取りルール

- 引いたカードの数字が、他プレイヤーの場にあるいずれかのカードと一致する場合、そのカードを横取りできる
- 横取りは任意。同時に複数プレイヤーの場からは1枚のみ横取り可能
- 横取りしたカードは自分の場に置かれる

### 勝利条件

- 山札のカードがなくなった時点でゲーム終了
- 最も得点が高いプレイヤーが勝利

---

## プレイヤーフロー

```
1. ブラウザでアクセス
      ↓
2. ニックネームを入力
      ↓
3-A. 新規ルーム作成（最大人数を設定）→ room_id 発行
3-B. 既存ルームに参加（room_id を入力）
      ↓
4. 全員が揃ったらゲーム開始（ホストが開始ボタン）
      ↓
5. ターン制で得点化 → カードを引く → バースト判定/横取り → 勝敗判定
      ↓
6. ゲーム終了 → 結果表示 → 再戦 or ルーム退出
```

## ゲーム状態管理の設計思想

DBを持たず、全状態をRedisで管理する。

### Redisキー設計

| キー | 型 | 内容 |
|------|----|------|
| `room:{room_id}` | Hash | ルーム情報（状態・最大人数・ホスト等） |
| `room:{room_id}:players` | List | 参加プレイヤー一覧（順番 = ターン順） |
| `game:{room_id}:deck` | List | 山札（シャッフル済み） |
| `game:{room_id}:field:{player_id}` | List | 各プレイヤーの場のカード |
| `game:{room_id}:scores` | Hash | 各プレイヤーの得点（`player_id` → `score`） |
| `game:{room_id}:turn` | Hash | 現在のターン情報（`current_player_id`, `phase`） |

TTL（有効期限）を設定し、放置されたルームは自動削除する。

### 実装メモ

- バースト判定・横取り可否はサーバーサイドで検証する（クライアント信頼不可）
- `GameState` オブジェクトで全状態を一元管理し、Redisへのアトミック操作を徹底する

## WebSocket接続フロー詳細

```
1. クライアント: ws://backend/ws/{player_id} に接続
2. サーバー: ConnectionManager に登録
3. クライアント: create_room または join_room イベント送信
4. サーバー: Redisにルーム状態を作成・更新
5. サーバー: 同ルームの全クライアントに player_joined をブロードキャスト
6. ゲーム中: score_cards → draw_card → バースト/横取り判定 → Redis更新 → ブロードキャスト
7. 切断時: サーバーがConnectionManagerから削除 → 他プレイヤーに通知
```

## 今後の開発予定（ロードマップ）

### 近期
- [x] だるまあつめ実装
- [ ] 途中入室の実装
- [ ] チャット機能
- [ ] 自動テスト追加（pytest / Vitest）

### 中期
- [ ] リプレイ機能
- [ ] スペクテーターモード

### 長期
- [ ] UI調整
- [ ] ユーザー登録・ログイン（オプション）
- [ ] パフォーマンス最適化
- [ ] モバイル対応強化
