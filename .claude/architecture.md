# アーキテクチャ

## システム構成図

```
┌──────────────────────┐        WebSocket         ┌──────────────────────┐
│    React Frontend    │◄────────────────────────►│   FastAPI Backend    │
│  (Vite + TypeScript) │                           │  (Python 3.11+)      │
└──────────────────────┘                           └──────────┬───────────┘
                                                              │
                                                              ▼
                                                   ┌──────────────────────┐
                                                   │        Redis         │
                                                   │   (State Store)      │
                                                   │   インメモリのみ     │
                                                   └──────────────────────┘
```

## 各レイヤーの責務

### Frontend（React + TypeScript）
- UIレンダリング・ゲーム盤面の表示
- WebSocketクライアントの接続・切断管理
- サーバーからのイベントを受信してUIに反映
- ユーザー操作をWebSocketイベントとして送信

### Backend（FastAPI）
- WebSocket接続の受付・`ConnectionManager` による接続管理
- 受信イベントのルーティングとゲームロジック実行
- Redisへのゲーム状態の読み書き
- 同ルームの全クライアントへのブロードキャスト

### Redis
- ゲームルーム・プレイヤー・ゲーム状態のインメモリ管理
- DBは使用しない（サーバー再起動で状態は消滅）
- TTLによる放置ルームの自動削除

---

## API仕様

### REST API

| メソッド | パス | 説明 |
|---------|------|------|
| GET | `/health` | ヘルスチェック |
| GET | `/rooms` | 公開ルーム一覧取得 |

### WebSocket接続

```
ws://localhost:8000/ws/{player_id}
```

### WebSocketイベント一覧

#### クライアント → サーバー

| イベント | ペイロード | 説明 |
|---------|-----------|------|
| `create_room` | `{nickname, max_players}` | ルームを作成する |
| `join_room` | `{room_id, nickname}` | 既存ルームに参加する |
| `play_card` | `{card_id}` | カードをプレイする |
| `leave_room` | `{}` | ルームから退出する |

#### サーバー → クライアント

| イベント | ペイロード | 説明 |
|---------|-----------|------|
| `room_created` | `{room_id}` | ルーム作成完了通知 |
| `player_joined` | `{nickname, player_count}` | プレイヤー参加通知 |
| `game_started` | `{players, cards}` | ゲーム開始・手札配布 |
| `card_played` | `{player, card}` | カードプレイ通知 |
| `turn_changed` | `{current_player}` | ターン変更通知 |
| `game_ended` | `{winner}` | ゲーム終了・勝者通知 |
| `error` | `{message}` | エラー通知 |

---

## エラーハンドリング方針

### WebSocket切断時
- `ConnectionManager` が切断を検知し、ルームから該当プレイヤーを除外
- 残りプレイヤーへ切断通知を送信
- ゲーム中の場合: そのプレイヤーのターンをスキップしゲームを継続（またはゲーム中断）

### Redis接続エラー時
- バックエンドが例外をキャッチし、`error` イベントをクライアントに送信
- 状態が破損した場合はルームを強制終了

### 無効なイベント受信時
- バックエンドでバリデーション（Pydantic）を実施
- バリデーション失敗時は `error` イベントで送信元クライアントに返す

---

## デプロイアーキテクチャ

```
インターネット
      ↓
ロードバランサー（HTTPS / WSS）
      ↓
┌──────────────┐  ┌──────────────┐
│  Frontend    │  │  Backend     │
│  Container   │  │  Container   │
│（静的配信）  │  │（FastAPI）   │
└──────────────┘  └──────┬───────┘
                          │
                   ┌──────▼───────┐
                   │    Redis     │
                   │（マネージド）│
                   └──────────────┘
```

**注意**: WebSocket接続にはロードバランサーのタイムアウト設定を長めに設定する必要がある。
